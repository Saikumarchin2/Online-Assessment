<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Exam Dashboard</title>
  <link rel="icon" type="image/x-icon" href="../components/exam.jpeg" />
  <link rel="stylesheet" href="examDashboard.css" />
</head>

<body>
  <header>
    <div class="brand">üìò Exam Dashboard</div>
    <div class="user-info">
      <span id="welcomeUser"></span>
      <button id="logoutBtn">Logout</button>
    </div>
  </header>

  <main class="dashboard">
    <h2>Available Exams</h2>
    <div class="exam-list" id="examList">
      <p class="loading">Loading exams...</p>
    </div>
  </main>

  <footer>
    ¬© 2025 Online Examination System | All Rights Reserved
  </footer>

  <!-- ‚úÖ MODAL FORM -->
  <div id="formModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3>Please Fill This Form Before Starting the Exam</h3>
      <form id="studentForm">
        <label>Full Name</label>
        <input type="text" id="name" required placeholder="Enter your name">

        <label>Date of Birth</label>
        <input type="date" id="dob" required>

        <label>Gender</label>
        <select id="gender" required>
          <option value="">Select Gender</option>
          <option>Male</option>
          <option>Female</option>
          <option>Other</option>
        </select>

        <label>Branch / Department</label>
        <input type="text" id="branch" required placeholder="Enter your branch">

        <label>Year of Study</label>
        <select id="year" required>
          <option value="">Select Year</option>
          <option>3rd Year</option>
          <option>4th Year</option>
          <option>Fresher</option>
        </select>
        <label>College/University Name</label>
        <input type="text" id="college" required placeholder="Enter college/university name">
        <label for="passingyear">Passing Year</label>
        <select id="passingyear" required>
          <option value="">Select Year of Passing</option>
          <option>2024</option>
          <option>2025</option>
          <option>2026</option>
        </select>        
        <label>Email</label>
        <input type="email" id="email" required placeholder="Enter email">

        <label>Phone</label>
        <input type="tel" id="phone" required pattern="[0-9]{10}" placeholder="10-digit number">
      <label for="photo">Upload Your Recent Photograph</label>
        <input type="file" id="photo" name="photo" accept="image/*" required>
        <label>Address</label>
        <textarea id="address" rows="3" placeholder="Enter address"></textarea>

        <button type="submit">Submit</button>
        <p class="success-message" id="successMsg">‚úÖ Form submitted successfully! You can now start your exam.</p>
      </form>
    </div>
  </div>

  <script>
const API = "http://localhost:5000";
const params = new URLSearchParams(window.location.search);
const userId = params.get("id") || localStorage.getItem("userId") || "guest";
const userEmail = params.get("email") || localStorage.getItem("userEmail") || "guest@example.com";
const username = params.get("name") || localStorage.getItem("username") || "Guest";

localStorage.setItem("userId", userId);
localStorage.setItem("userEmail", userEmail);
localStorage.setItem("username", username);

document.getElementById("welcomeUser").textContent = `üëã Welcome, ${username}`;
const examList = document.getElementById("examList");

// ‚úÖ Load exams
async function loadExams() {
  try {
    const res = await fetch(`${API}/admin/tests`);
    const exams = await res.json();
    examList.innerHTML = "";

    if (!exams.length) {
      examList.innerHTML = "<p>No exams available right now.</p>";
      return;
    }

    // ‚úÖ Fetch current student's data once
    let studentData = null;
    try {
      const studentRes = await fetch(`${API}/api/studentDetails/${userEmail}`);
      const studentJson = await studentRes.json();
      if (studentJson.success) studentData = studentJson.student;
    } catch {
      studentData = null;
    }

    for (const exam of exams) {
      // ‚úÖ Determine Take Test button state
      let testBtnStatus = studentData && studentData.testsTaken === false;

      const safeEmail = userEmail.replace(/[@.]/g, "_");

      const card = document.createElement("div");
      card.classList.add("exam-card");

      card.innerHTML = `
        <div class="exam-details">
          <h3>${exam.title}</h3>
          <p><strong>Company:</strong> ${exam.subject}</p>
          <p><strong>Total Questions:</strong> ${exam.questions.length}</p>
          <p><strong>Duration:</strong> ${exam.duration || "20"} mins</p>
          <p><strong>Exam Created On:</strong> ${new Date(exam.createdAt).toLocaleDateString()}</p>
        </div>

        <div class="exam-actions">
          <button id="fillBtn-${exam._id}" class="fillBtn" onclick="openForm('${exam._id}', '${userEmail}')">üìù Fill Form</button>
          <button class="takeBtn" id="takeBtn-${exam._id}-${safeEmail}" ${testBtnStatus ? "" : "disabled"}>üéØ Take Test</button>
          <button class="resultBtn" id="resultBtn-${exam._id}" onclick="reportTest('${exam._id}', '${exam.title}')" ${exam.resultsDeclared ? "" : "disabled"}>üìä Results</button>
        </div>`;

      examList.appendChild(card);

      // ‚úÖ Add click event to take test
      document
        .getElementById(`takeBtn-${exam._id}-${safeEmail}`)
        .addEventListener("click", () => takeTest(exam._id));
    }
  } catch (error) {
    console.error("Error fetching exams:", error);
    examList.innerHTML = "<p>‚ö†Ô∏è Unable to load exams. Please try again later.</p>";
  }
}

// ‚úÖ Modal Logic
let currentExamId = null;
let currentUserEmail = null;

function openForm(testId, userEmail) {
  currentExamId = testId;
  currentUserEmail = userEmail;
  document.getElementById("formModal").style.display = "flex";
}

function closeModal() {
  document.getElementById("formModal").style.display = "none";
  document.getElementById("studentForm").reset();
  document.getElementById("successMsg").style.display = "none";
}

// ‚úÖ Handle student form submission
document.getElementById("studentForm").addEventListener("submit", async function (e) {
  e.preventDefault();

  const fileInput = document.getElementById("photo");
  const file = fileInput.files[0];
  const base64Photo = await toBase64(file);

  const studentData = {
    name: document.getElementById("name").value,
    dob: document.getElementById("dob").value,
    gender: document.getElementById("gender").value,
    branch: document.getElementById("branch").value,
    year: document.getElementById("year").value,
    college: document.getElementById("college").value,
    passingyear: document.getElementById("passingyear").value,
    email: document.getElementById("email").value,
    phone: document.getElementById("phone").value,
    photo: base64Photo,
    address: document.getElementById("address").value,
  };

  try {
    const res = await fetch(`${API}/api/studentDetails`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(studentData),
    });

    const data = await res.json();
    if (data.success) {
      const msg = document.getElementById("successMsg");
      msg.style.display = "block";

      // ‚úÖ Enable Take Test button after form submission
      const safeEmail = currentUserEmail.replace(/[@.]/g, "_");
      const takeBtn = document.getElementById(`takeBtn-${currentExamId}-${safeEmail}`);
      if (takeBtn) takeBtn.disabled = false;

      setTimeout(() => closeModal(), 2000);
    } else {
      alert("‚ùå Error: " + data.message);
    }
  } catch (err) {
    console.error("Error submitting form:", err);
    alert("Failed to submit form");
  }
});

// ‚úÖ Convert file to Base64
function toBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = (error) => reject(error);
  });
}

// ‚úÖ Start Test
function takeTest(testId) {
  window.location.href = `exam.html?testId=${testId}&id=${encodeURIComponent(userId)}&name=${encodeURIComponent(username)}&email=${encodeURIComponent(userEmail)}`;
}

// ‚úÖ After Test Submission (called in exam.js)
async function markTestAsTaken(userEmail) {
  try {
    await fetch(`${API}/api/updateTestsTaken/${userEmail}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ testsTaken: true }),
    });
    console.log("‚úÖ Updated student test status to taken");
  } catch (err) {
    console.error("Error updating test status:", err);
  }
}

function reportTest(testId, title) {
  window.location.href = `report.html?examId=${testId}&exam=${encodeURIComponent(title)}&id=${encodeURIComponent(userId)}&name=${encodeURIComponent(username)}&email=${encodeURIComponent(userEmail)}`;
}

// ‚úÖ Logout
document.getElementById("logoutBtn").onclick = () => {
  if (confirm("Are you sure you want to logout?")) {
    localStorage.clear();
    window.location.href = "../index.html";
  }
};

loadExams();
</script>
</body>
</html>
